#!/bin/bash

# --- Color Definitions ---
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}======================================"
echo -e "      WinBoat Auto-Setup Script"
echo -e "======================================${NC}"

if ! lscpu | grep -q "Virtualization"; then
  echo -e "${RED}Error: Virtualization (VT-x/AMD-V) is not enabled in your BIOS/UEFI.${NC}"
  exit 1
fi

echo -e "${YELLOW}Step 1: Installing system dependencies...${NC}"
sudo pacman -S --needed --noconfirm docker docker-compose freerdp qemu-full virt-manager dnsmasq bridge-utils git

echo -e "${YELLOW}Step 2: Configuring Docker...${NC}"
sudo systemctl enable --now docker
sudo usermod -aG docker $USER

sudo modprobe ip_tables
sudo modprobe iptable_nat

echo -e "\n${BLUE}--- Configuration Settings ---${NC}"

read -p "Enter desired Disk Space (e.g., 64G, 128G) [Default: 64G]: " USER_DISK
USER_DISK=${USER_DISK:-64G}

read -p "Enter RAM allocation (e.g., 4G, 8G) [Default: 4G]: " USER_RAM
USER_RAM=${USER_RAM:-4G}

read -p "Enter number of CPU cores [Default: 2]: " USER_CPU
USER_CPU=${USER_CPU:-2}

echo -e "\n${YELLOW}Step 3: Installing WinBoat (AUR)...${NC}"
if ! command -v yay &>/dev/null; then
  echo "AUR helper (yay) not found. Installing yay..."
  git clone https://aur.archlinux.org/yay.git
  cd yay && makepkg -si --noconfirm && cd .. && rm -rf yay
fi
yay -S --noconfirm winboat-bin

mkdir -p "$HOME/.winboat"
cat <<EOF >"$HOME/.winboat/.env"
DISK_SIZE=$USER_DISK
RAM_SIZE=$USER_RAM
CPU_CORES=$USER_CPU
EOF

cat <<EOF >"$HOME/.local/share/applications/windows.desktop"
[Desktop Entry]
Version=1.0
Type=Application
Name=Windows
Comment=Lauch Windows
Exec=connect-2-windows
Icon=$HOME/.local/share/applications/icons/windows.png
Terminal=True
Categories=Microsoft
StartupNotify=true
EOF

echo -e "\n${GREEN}======================================"
echo -e "   SETUP COMPLETE!"
echo -e "======================================${NC}"
echo -e "${YELLOW}IMPORTANT:${NC}"
echo -e "1. You ${RED}MUST REBOOT${NC} or logout for Docker group changes to take effect."
echo -e "2. After rebooting, you will see the WinBoat app in your Walker."
echo -e "3. WinBoat will then download the Windows ISO and begin the automated install."
echo -e "4. Your chosen specs ($USER_DISK Disk, $USER_RAM RAM, $USER_CPU Cores) have been saved."
