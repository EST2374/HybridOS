#!/bin/bash

WP_PATH="$HOME/.local/share/HybridOS/wallpapers"

selected=$(find "$WP_PATH" -maxdepth 1 -type f \( -iname "*.png" -o -iname "*.jpg" -o -iname "*.jpeg" \) | sort | while read -r path; do
  echo "$(basename "${path%.*}" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-/ /g')"
done | walker --dmenu -p "Select Background")

if [ -n "$selected" ]; then
  filename=$(echo "$selected" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g')
  full_path=$(find "$WP_PATH" -name "$filename.*" | head -n 1)
  dbus-send --session --dest=org.kde.plasmashell --type=method_call /PlasmaShell org.kde.PlasmaShell.evaluateScript "string:
var Desktops = desktops();
for (i=0;i<Desktops.length;i++) {
    d = Desktops[i];
    d.currentConfigGroup = Array('Wallpaper', 'org.kde.image', 'General');
    d.writeConfig('Image', 'file://$full_path');
}"
fi
